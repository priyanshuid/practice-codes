DISQUS.define("discovery.collections",function(){"use strict";var a=_.strip,b=DISQUS.use("discovery.models"),c=DISQUS.use("discovery.helpers"),d=Backbone.Collection.extend({url:function(a){return DISQUS.api.getURL(a)},fetch:function(a){return a=a||{},a.reset=!0,Backbone.Collection.prototype.fetch.call(this,a)},parse:function(a){return a.response}}),e=function(b){var c=b.prototype;return b.extend({url:function(){return c.url.call(this,"discovery/listTopPost.json")},parse:function(b){for(var d=c.parse.call(this,b),e=0,f=d.length;f>e;e++)d[e].plaintext=a(d[e].message);return d}})}(d),f=function(a){return a.extend({initialize:function(a,c){this.model=b[this.modelName],c&&_.has(c,"fetchLimit")&&(this.fetchLimit=c.fetchLimit)},fetch:function(b){return this.fetchLimit&&b.data&&(b.data[this.fetchLimitKey||"limit"]=this.fetchLimit),a.prototype.fetch.call(this,b)}})}(d),g=function(a){var b=a.prototype;return a.extend({modelName:"RelatedThread",url:function(){return b.url.call(this,"discovery/listRelated.json")}})}(f),h=function(a){return a=a||{},a.dataType="jsonp",a.omitDisqusApiKey=!0,a.data=a.data||{},delete a.data.thread,a},i=function(a){var b=a.prototype;return a.extend({modelName:"Advertisement",url:"//tempest.services.disqus.com/listPromoted",fetch:_.compose(function(a){return _.has(a.data,"limit")&&(a.data[this.fetchLimitKey]=a.data.limit,delete a.data.limit),b.fetch.call(this,a)},h),fetchLimitKey:"count"})}(f),j=function(a){var b=a.prototype;return a.extend({initialize:function(a,c){b.initialize.apply(this,arguments),this.sessionStorage=c&&c.sessionStorage||window.sessionStorage},modelName:"TaboolaAdvertisement",url:function(a){return a=!DISQUS.debug&&a,"http://api.taboola.com/1.1/json/disqus"+(a?"-"+a:"")+"/recommendations.get"},getTaboolaSession:function(){var a;try{a=this.sessionStorage.getItem("taboolaSession")}catch(b){}return a||"init"},setTaboolaSession:function(a){try{this.sessionStorage.setItem("taboolaSession",a)}catch(b){c.log("Unable to store Taboola session in sessionStorage")}},fetch:_.compose(function(a){a.url=this.url(a.forum),_.extend(a.data,{"app.type":"desktop","app.apikey":"037849ccb5a799c70e319e9592c66e8b387105ff","source.type":"text","source.id":a.sourceThread.id,"source.url":a.sourceThreadUrl,"source.placement":a.placement,"user.session":this.getTaboolaSession()});var c=window.$&&window.$.fn&&window.$.fn.jquery&&window.$.fn.jquery.indexOf("1.9.2")>-1;return c?a.jsonp="rec.callback":a.jsonpCallback="rec.callback",_.has(a.data,"limit")&&(a.data[this.fetchLimitKey]=a.data.limit,delete a.data.limit),b.fetch.call(this,a)},h),fetchLimitKey:"rec.count",parse:function(a){this.setTaboolaSession(a.session);var b=79264;return _.map(a.list,function(a){return a.advertisement_id=b++,a})}})}(f),k={PostCollection:e,RelatedThreadCollection:g,AdvertisementCollection:i,TaboolaAdvertisementCollection:j};return DISQUS.testing&&(k.BaseCollection=d,k.BaseContentCollection=f),k}),DISQUS.define("discovery.helpers",function(a,b){"use strict";var c=!1,d=!1,e=function(a){c=!!a.lineTruncationEnabled,d=!!a.consoleLoggingEnabled},f=function(a){return $(a).closest("body").length&&!a.offsetTop},g=function(){return DISQUS.browser.mobile},h=function(){};a.console&&(h=function(){if(d){var b=_.toArray(arguments);b.unshift("[Discovery]"),a.console.log.apply?a.console.log.apply(a.console,b):a.console.log(b.join(" "))}});var i=function(a){return a===b?d:(d=!!a,void 0)},j=function(a){return a===b?c:(c=!!a,void 0)},k=function(b,d){function e(){return j.scrollHeight-j.offsetHeight>.2*k}function f(){i.lastChild&&!_.contains(["...","…"],i.lastChild.nodeValue)&&(l=i.appendChild(a.document.createTextNode(" "+n)),e()&&(i.removeChild(l),i.removeChild(i.lastChild),f()))}if(c){var g=DISQUS.logError||function(){};if(!b.closest("body").length)return void g("lineTruncate called on el not on DOM");if(b.text().length<1)return void g("lineTruncated called on empty el");var h=function(a){return 3!==a.nodeType};if(_.any(b.children(),h))return void g("lineTruncate called on non-flat el");var i=b[0],j=i;if("block"!==b.css("display"))for(;j.parentNode&&(j=j.parentNode,"block"!==$(j).css("display")););var k=parseFloat(b.css("font-size"),10);if(e()){d=d||{};var l,m=d.lines||1,n=d.ellipsis,o=b.text();if(o.length){var p=b.width()/k,q=parseInt(p*m,10),r=o.split(/\s/),s=0;b.empty();for(var t=0,u=r.length;u>t&&(s+=r[t].length+1,!(s>=q));t++)i.appendChild(document.createTextNode(" "+r[t]));if(e()){do l=i.removeChild(i.lastChild);while(e())}else{do l=i.appendChild(document.createTextNode(" "+r[t++]));while(!e()&&u>t);i.removeChild(l)}n&&(_.isString(n)||(n="…"),f())}}}},l=function(a){function b(a,b){return a+b}var c,d,e=_.keys(a),f=Math.floor(_.reduce(a,b,0)/2),g=e.length+1,h=f+1,i=new Array(g);for(c=0;g>c;c++)i[c]=new Array(h),i[c][0]={};for(d=1;h>d;d++)i[0][d]=!1;var j,k,l,m={};for(d=1;h>d;d++)for(c=1;g>c;c++)j=e[c-1],k=a[j],l=_.clone(i[c-1][d]),!l&&d>=k&&(l=_.clone(i[c-1][d-k]),l&&(l[j]=k,m=l)),i[c][d]=l;return[m,_.omit(a,_.keys(m))]};return{config:e,looksAdblocked:f,isMobile:g,log:h,allowLog:i,allowLineTruncate:j,lineTruncate:k,balancedPartition:l}}),DISQUS.define("discovery",function(){"use strict";function a(a){var b=_.object(_.map(["lineTruncationEnabled","consoleLoggingEnabled"],function(b){return b in a?[b,a[b]]:[b,e.prototype.defaults[b]]}));return d.config(b),new e(a)}var b=DISQUS.use("discovery.collections"),c=DISQUS.use("discovery.views"),d=DISQUS.use("discovery.helpers"),e=Backbone.Model.extend({defaults:{name:"promoted",inlineMeta:!0,contentPreviews:!1,promotedEnabled:!0,topPlacementEnabled:!1,redirectUrl:"https://redirect.disqus.com/url",listRelatedLimit:null,listPromotedLimit:null,httpTimeout:1e4,sourceThread:null,sourceForum:null,sourceThreadUrl:null,useTaboolaAdserver:!1,organicExperimentsEnabled:!1,help:!1,display:!1,columnEveningEnabled:!0,numColumns:2,minPerColumn:1,maxPerColumn:4,toleranceCoefficient:1.2,maxOrganicTextLinks:null,maxPromotedTextLinks:null,maxOrganicThumbnailLinks:null,maxPromotedThumbnailLinks:null,minWidthForColumnLayout:440,containerId:"discovery",topPlacementContainerId:"discovery-top",innerContainerName:"discovery-main",sectionNames:["col-organic","col-promoted"],collectionTagName:"ul",collectionClassName:"discovery-posts",promotedSide:"right",consoleLoggingEnabled:DISQUS.debug,lineTruncationEnabled:!0,session:null,numLinesHeadline:2,thumbnailsEnabled:!1,thumbnailMinHeight:200,thumbnailMinWidth:200,thumbnailAspectRatioMin:.5,thumbnailAspectRatioMax:1.8,shouldEvenThumbnails:!1,thumbnailTimeout:2e3,minThumbnailsNeeded:null,js:null,css:null},get:function(a){if(a in e.loggedinOverrides){var b=this.get("session");if(b&&!b.isAnonymous())return e.loggedinOverrides[a]}return Backbone.Model.prototype.get.apply(this,arguments)},initialize:function(){var a=this;this.collections=[],a.configure(),a.once("change:display",function(){a.onComplete()}),_.bindAll(a,"getContentPreviews","validateData","showData"),a.run()},configure:function(){var a=this;if(a.has("maxPerColumn")){var b=a.get("promotedEnabled")?1:2;a.set("maxOrganicTextLinks",b*a.get("maxPerColumn")),a.set("maxPromotedTextLinks",a.get("maxPerColumn"))}else a.has("maxOrganicTextLinks")&&a.set("maxPerColumn",a.get("maxOrganicTextLinks"));a.set("innerContainerId",a.get("innerContainerName")+"-"+a.cid),a.set("sectionIds",_.map(a.get("sectionNames"),function(b){return b+"-"+a.cid})),a.get("topPlacementEnabled")&&a.set("containerId",a.get("topPlacementContainerId")),a.get("thumbnailsEnabled")&&a.activateThumbnails()},numSections:function(){return this.collections.length||(this.get("promotedEnabled")?2:1)},commonClickMetadata:function(){var a=this.get("sourceThread"),b=this.get("sourceForum"),c={redirectUrl:this.get("redirectUrl"),sourceThreadId:a.id,forumId:b.pk,forum:b.id,majorVersion:this.majorVersion(),requestBin:this.get("requestBin")},d=this.get("session");return d&&d.isRegistered()&&(c.userId=d.user.id),c},augmentModels:function(a){a.invoke("set",this.commonClickMetadata())},augmentCollection:function(a){var b=this,c=b.get("max"+(a===b.threads?"Organic":"Promoted")+"ThumbnailLinks"),d=a.meta={max:function(){return d.useThumbnails&&c||b.get("numColumns")/b.numSections()*b.get("maxPerColumn")},min:function(){return b.get("minThumbnailsNeeded")||b.get("numColumns")/b.numSections()*b.get("minPerColumn")},useThumbnails:c}},run:function(){var a=_.bind(this.onComplete,this);this.getData().then(this.validateData).then(this.showData).otherwise(a)},getPlacement:function(){var a="",b=this.threads.meta.max(),c=b;return a+=b+" unpaid ",a+=this.get("thumbnailsEnabled")?"thumbnail":"text",a+=" links ",this.get("promotedEnabled")&&(a+="and "+c+" paid ",a+=this.get("thumbnailsEnabled")?"thumbnail":"text",a+=" links "),a+=this.get("topPlacementEnabled")?"above":"below",a+=" embed"},generateFetchOptions:function(a){var b={timeout:this.get("httpTimeout"),data:{thread:this.get("sourceThread").id,limit:2*a.meta.max()},sourceThread:this.get("sourceThread")};return this.get("useTaboolaAdserver")&&(b.data.limit=4,b.sourceThreadUrl=this.get("sourceThreadUrl"),b.forum=this.get("sourceForum").id,b.placement=this.getPlacement()),b},getDataOrganic:function(){var a=this;a.threads=new b.RelatedThreadCollection(null,{fetchLimit:this.get("listRelatedLimit")}),a.augmentCollection(a.threads);var c=this.generateFetchOptions(a.threads);c.humanFriendlyTimestamp=!0;var e=when(a.threads.fetch(c));if(a.get("contentPreviews")&&(e=e.then(function(){return a.getContentPreviews().otherwise(function(a){d.log("There was a problem getting snippets:",a)})})),a.get("organicExperimentsEnabled")){var f=a.getOrganicExperiment().then(function(b){b&&a.organicExperimentHandlers[b]&&a.organicExperimentHandlers[b].call(a)});return when.join(e,f)}return e},activateThumbnails:function(){var a=this;d.log("Organic thumbnails must meet the following requirements:"),d.log("Minimum width",a.get("thumbnailMinWidth"),"px"),d.log("Minimum height",a.get("thumbnailMinHeight"),"px"),d.log("Minimum aspect ratio",a.get("thumbnailAspectRatioMin"),"px"),d.log("Maximum aspect ratio",a.get("thumbnailAspectRatioMax"),"px"),_.each(a.collections,function(a){a.meta.useThumbnails=!0}),a.set({columnEveningEnabled:!1,contentPreviews:!1,thumbnailsEnabled:!0})},deactivateThumbnails:function(){_.each(this.collections,function(a){a.meta.useThumbnails=!1}),this.set({columnEveningEnabled:!0,contentPreviews:!0,thumbnailsEnabled:!1})},organicExperimentHandlers:{"embed:organic_discovery:tempest:thumbnails:active":function(){this.activateThumbnails(),this.set("minThumbnailsNeeded",2),this.set("maxOrganicTextLinks",4),this.set("maxOrganicThumbnailLinks",4),this.set("shouldEvenThumbnails",!0)}},getOrganicExperiment:function(){var a=this,c=when.defer();return a.get("promotedEnabled")?c.resolve(null):($.ajax({url:b.AdvertisementCollection.prototype.url,data:{count:0},dataType:"jsonp",success:function(b){var d;b&&b.bin&&(d=b.bin,a.set("requestBin",d)),c.resolve(d)},error:function(){c.resolve(null)}}),c.promise)},getDataPromoted:function(){var a=this,c=a.get("useTaboolaAdserver")?b.TaboolaAdvertisementCollection:b.AdvertisementCollection;a.ads=new c(null,{fetchLimit:a.get("listPromotedLimit")}),a.augmentCollection(a.ads);var d=a.generateFetchOptions(a.ads),e=when(a.ads.fetch(d)),f=e.then(function(b){var c=b.bin;return c?a.has("requestBin")?e:(a.set("requestBin",c),a.handleExperiment(c)):e});return f},getData:function(){var a=this.getDataOrganic();if(this.get("promotedEnabled")){var b=this.getDataPromoted();a=a.always(function(){return b})}return a.always(_.bind(this.sequenceDataCollections,this))},sequenceDataCollections:function(){this.collections=_.compact([this.threads,this.ads]),"left"===this.get("promotedSide")&&this.collections.reverse()},handleExperiment:function(a){return this.experimentHandlers[a]?this.experimentHandlers[a].call(this):void 0},experimentHandlers:{"embed:promoted_discovery:tempest:taboola:active":function(){return this.set("experimentVariant","taboola"),this.set("useTaboolaAdserver",!0),this.getDataPromoted()},"embed:promoted_discovery:tempest:mirror:active":function(){this.set("promotedSide","left")},"embed:promoted_discovery:tempest:taboola:thumbnails":function(){return this.activateThumbnails(),this.set({maxOrganicThumbnailLinks:3,maxPromotedThumbnailLinks:3,useTaboolaAdserver:!0,promotedSide:"left",numLinesHeadline:3}),this.getDataPromoted()}},getContentPreviews:function(){var a=this.threads.pluck("id");if(a.length<this.threads.meta.min())return when.resolve();this.previews=new b.PostCollection;var c=when(this.previews.fetch({data:{thread:a},timeout:this.get("httpTimeout")}));return c.then(_.bind(this.attachPreviews,this))},attachPreviews:function(){var a=this;a.previews.each(function(b){var c=b.get("thread"),d=a.threads.get(c);d&&d.set("preview",b)})},validateCollectionMin:function(){for(var a,b,c=this.collections,d=c.length;d>0;)a=c[--d],b=a.meta.min(),a.length<b&&(c.splice(d,1),d=c.length)},trimCollections:function(){var a,b,c=this.collections,e=c.length;if(e=c.length,e>0)for(var f=0;e>f;f++)a=c[f],b=a.meta.max(),a.length>b&&a.reset(a.slice(0,b));this.get("shouldEvenThumbnails")&&0!==this.threads.length%2&&(d.log("Number of related threads ("+this.threads.length+") is odd.","Removing one to make even."),this.threads.pop())},isThumbnailOk:function(a){var b=this,c=a.width,d=a.height,e=c/d;return c>=b.get("thumbnailMinWidth")&&d>=b.get("thumbnailMinHeight")&&e>=b.get("thumbnailAspectRatioMin")&&e<=b.get("thumbnailAspectRatioMax")},areThumbnailsGood:function(a,b){var c=this;return a.map(function(a){var e,f=new Image,g=when.defer();return $(f).on("load",function(){c.isThumbnailOk(this)?(b.push(a),g.resolve(a.id)):(d.log("Image is not good. Width",this.width,"Height",this.height,"Aspect Ratio",this.width/this.height,"Src",this.src),g.reject("Image is not good")),clearTimeout(e)}).on("error",function(){d.log("Image could not be loaded. Src",this.src),g.reject("Error loading image"),clearTimeout(e)}),f.src=a.get("thumbnail"),e=_.delay(function(){d.log("Image is taking too long to load. Src",f.src),g.reject("Image taking too long")},c.get("thumbnailTimeout")),g.promise})},validateThumbnails:function(a){function b(){return d.log("Verified minimum number of thumbnails needed: "+f),when.some(i,g).then(function(b){var c=a.pluck("id"),e=_.difference(c,b);d.log("Maximum number ("+g+") of thumbnails verified.","Removing excess models.",e),a.reset(h)},function(){d.log("Cannot reach thumbnail max. Carrying on with the amount obtained: "+h.length),a.reset(h)})}function c(){d.log("Cannot get enough good thumbnails. Falling back to normal design."),e.deactivateThumbnails()}if(a.length){var e=this,f=a.meta.min(),g=a.meta.max(),h=[],i=e.areThumbnailsGood(a,h);return i.length<f?when.resolve(c()):when.some(i,f).then(b,c)}},validateData:function(){if(d.isMobile()&&this.ads&&this.ads.length>0&&this.ads.remove(this.ads.where({mobile:!1})),this.validateCollectionMin(),0===this.collections.length)throw"Not enough data";return _.each(this.collections,this.augmentModels,this),this.get("thumbnailsEnabled")?this.validateThumbnails(this.threads):void 0},renderViews:function(){function a(a){_.extend(this,a),this.appContext=b.toJSON()}var b=this,d=document.getElementById(b.get("containerId"));if(!d)throw"No container on the DOM";var e=b.mainView=new c.MainView(new a({el:d,model:b}));e.render();var f=b.get("sectionIds"),g=b.get("collectionTagName"),h=b.get("collectionClassName");b.views=_.map(b.collections,function(b,d){var e=new c.BaseCollectionView(new a({collection:b,el:$("#"+f[d]+" "+g+"."+h)}));return b.meta.view=e,e}),b.get("thumbnailsEnabled")&&b.get("maxOrganicThumbnailLinks")&&b.get("maxPromotedThumbnailLinks")?e.$el.find("#"+b.get("innerContainerId")).addClass("doublethumbnails"):2===b.views.length&&e.$el.find("#"+b.get("innerContainerId")).addClass("doublesection"),_.invoke(b.views,"render")},evenColumns:function(){var a=this;if(!a.get("thumbnailsEnabled"))if(a.get("columnEveningEnabled")&&a.mainView.$el.width()>a.get("minWidthForColumnLayout")){var b=new c.TwoColumn({views:a.views,fudge:this.get("toleranceCoefficient")});b.render()}else{var d=_.min(_.pluck(a.collections,"length"));_.each(a.views,function(a){for(;a.collection.length>d;)a.collection.pop()})}},showData:function(){var a=this;a.trimCollections(),a.renderViews(),a.manageAdblock(),a.evenColumns(),a.set("display",!0)},manageAdblock:function(){var a=this.ads&&this.ads.meta.view;if(a&&d.looksAdblocked(a.el)){if(!(this.views.length>1))throw"No organic results and promoted results appear to be blocked";this.mainView.remove({cloneContainer:!0}),this.ads.reset(null,{silent:!0}),this.validateCollections(),this.renderViews()}},onComplete:function(a){var b=d.log;return this.onCompleteCalled?b("Error: Final reporting function called more than once"):(this.onCompleteCalled=!0,a&&b("It looks like there was a problem:",a),this.report(),void 0)},report:function(){var a=d.log,b=this.snapshot(),c=DISQUS.juggler.client("juggler");if(!c)return void a("Cannot report app state, no client found");if(a("Sending analytics data about this Discovery impression:"),a("init_discovery: ",b),c.emit("init_discovery",b),this.get("darkJester")){var e=DISQUS.juggler.client("jester",!0);e.emit("init_discovery",b)}},majorVersion:function(){return this.get("promotedEnabled")?"midway":"metadata"},snapshot:function(){var a=this.threads,b={major_version:this.majorVersion(),internal_organic:a.length,external_organic:0,promoted:0,display:this.get("display"),placement:this.get("containerId")===this.get("topPlacementContainerId")?"top":"bottom"};if(this.has("requestBin")&&(b.bin=this.get("requestBin")),this.get("promotedEnabled")){var c=this.ads;_.extend(b,{promoted:c.length,promoted_ids:JSON.stringify(c.pluck("advertisement_id"))})}return b}},{loggedinOverrides:{topPlacementEnabled:!1,promotedSide:"right",maxPromotedTextLinks:2,maxPerColumn:2}}),f={};return DISQUS.testing&&(f.DiscoveryApp=e),f.init=a,f}),DISQUS.define("discovery.models",function(){"use strict";var a=DISQUS.use("time"),b=function(a){var b=a.prototype;return a.extend({defaults:{redirectUrl:null,signedUrl:null,userId:null,sourceThreadId:null,forumId:null,forum:null,majorVersion:null,requestBin:null},redirectPayload:function(){var a={url:this.get("signedUrl"),imp:DISQUS.juggler.impId,forum_id:this.get("forumId"),forum:this.get("forum"),thread_id:this.get("sourceThreadId"),major_version:this.get("majorVersion")};return this.has("requestBin")&&(a.bin=this.get("requestBin")),this.has("userId")&&(a.user_id=this.get("userId")),a},redirectUrl:function(){var a=this.get("redirectUrl"),b=this.redirectPayload();return DISQUS.serialize(a,b)},toJSON:function(){var a=b.toJSON.call(this);return a.redirectUrl=this.redirectUrl(),a},toString:function(){return this.get("title")+" "+this.get("link")+" (id = "+this.id+")"}})}(Backbone.Model),c=function(b){var c=b.prototype;return b.extend({defaults:_.defaults({createdAgo:!1},c.defaults),initialize:function(b,c){if(c&&c.humanFriendlyTimestamp){var d=a.assureTzOffset(this.get("createdAt"));d=moment(d,a.ISO_8601),this.set("createdAgo",d.fromNow())}},redirectPayload:function(){var a=c.redirectPayload.call(this);return _.extend(a,{thread:this.id,zone:"internal_discovery"}),a},toJSON:function(){var a=c.toJSON.call(this);return a.preview&&(a.preview=a.preview.toJSON()),a},toString:function(){return"organic link: "+c.toString.call(this)}})}(b),d=function(a){var b=a.prototype;return a.extend({idAttribute:"advertisement_id",defaults:_.defaults({brand:null,headline:null,text:null,url:null,signedUrl:null,advertisement_id:null},b.defaults),parse:function(a){return a.signedUrl=a.signed_url,delete a.signed_url,a},get:function(a){return{title:this.attributes.headline,link:this.attributes.url}[a]||b.get.call(this,a)},redirectPayload:function(){var a=b.redirectPayload.call(this);return _.extend(a,{zone:"promoted_discovery",advertisement_id:this.get("advertisement_id"),brand:this.get("brand"),headline:this.get("headline")}),a},toJSON:function(){var a=b.toJSON.call(this);return a.title=a.headline,a.link=a.url,a},toString:function(){return"promoted link: "+b.toString.call(this)}})}(b),e=function(a){return a.extend({idAttribute:"advertisement_id",apiMapping:{headline:"name",signedUrl:"url",brand:"branding"},parse:function(a){_.each(this.apiMapping,function(b,c){a[b]&&(a[c]=a[b],delete a[b])});var b=a.thumbnail;return a.thumbnail=b&&b.length&&b[0]&&b[0].url,a}})}(d),f={RelatedThread:c,Advertisement:d,TaboolaAdvertisement:e};return DISQUS.testing&&(f.BaseContentModel=b),f}),DISQUS.define("discovery.views",function(){"use strict";var a=DISQUS.use("discovery.helpers"),b=Backbone.View.extend({initialize:function(a){a&&a.appContext&&(this.appContext=a.appContext)},getTemplateContext:function(){return this.appContext?{variant:this.appContext}:{}},template:function(a,b){return b=b||this.templateName,DISQUS.renderBlock(b,a)}}),c=function(c){var d=c.prototype;return c.extend({events:{"click [data-redirect]":"handleClick"},handleClick:function(a){this.swapHref(a.currentTarget)},swapHref:function(a){a.setAttribute("data-href",a.getAttribute("href")),a.setAttribute("href",a.getAttribute("data-redirect")),_.delay(function(){a.setAttribute("href",a.getAttribute("data-href"))},100)},templateName:"discoveryCollection",initialize:function(a){d.initialize.call(this,a),this.elementsSelector="li.discovery-post",this.$elements=this.$el.find(this.elementsSelector);var b=this.collection;b.on("remove",this.remove,this),b.on("reset",this.render,this)},truncate:function(){var b=this.$el.find(".line-truncate");_.each(b,function(b){var c=$(b);a.lineTruncate(c,{lines:parseInt(c.attr("data-line-truncate"),10),ellipsis:!0})})},getTemplateContext:function(){var a=d.getTemplateContext.call(this);a.collection=this.collection.toJSON();var b=this.collection.at(0);if(b){var c=b.has("id")?"organic-":"promoted-",e=b.idAttribute;_.each(a.collection,function(a){a.domIdSuffix=a[e],a.domIdSuffix=c+a.domIdSuffix})}return a},render:function(){var a=this.getTemplateContext();return this.$el.html(this.template(a)),this.$elements=this.$el.find(this.elementsSelector),this.truncate(),this},remove:function(a,c,d){if(0===arguments.length)return b.prototype.remove.call(this);var e=_.toArray(this.$elements),f=e.splice(d.index,1)[0];return $(f).remove(),this.$elements=$(e),this}})}(b),d=function(a,b){this.modelIds=a||[],this.$elements=$(b||[])};_.extend(d.prototype,{height:function(){var a=this;a.heights=[];var b=$(a.$elements),c=b.first().offset().top,d=function(){var a=b.last();return a.offset().top+a.height()}(),e=d-c,f=0;return _.each(b,function(b){var c=$(b).height();a.heights.push(c),f+=c}),this.interstice=(e-f)/(b.length-1),e}});var e=function(){this.divideIntoColumns=function(){var a=this,b=a.subviews[0];a.left=new d,a.right=new d;var c=0;b.collection.each(function(d,e){var f=0===c++%2?"left":"right";a[f].modelIds.push(d.id),Array.prototype.push.call(a[f].$elements,b.$elements[e])})},this.removeOneFromColumn=function(a,b){var c,d=_.chain(a.modelIds).map(function(b,c){return[b,a.heights[c]]}).sortBy(function(a){return-1*a[1]}).find(function(a){return a[1]<=b}).value()[0],e=this.subviews[0].collection,f=e.models,g=e.get(d),h=f.indexOf(g),i=[],j=[],k=[j,i],l=f.length;for(c=0;l>c;c++)k[c%2].push(f[c]);var m=k[h%2];m.splice(_.indexOf(m,g),1),f=[];var n=(h+1)%2;for(c=0;l-1>c;c++)f.push(k[(c+n)%2].shift());e.reset(f)},this.balanceColumns=function(){var b=this.subviews[0],c=b.collection,d={};c.each(function(a,c){d[c]=b.$elements[c]});var e=a.balancedPartition(d);e=_.sortBy(e,"length");var f=e[1],g=e[0],h=c.models,i=new Array(h.length);_.each(f,function(a,b){i[2*b]=h[b]}),_.each(g,function(a,b){i[2*b+1]=h[b]}),c.reset(h)},this.shortenColumn=function(a,b){var c=this.subviews[0].collection;0!==c.length%2&&a===this.left?this.removeOneFromColumn(a,this.fudge*b):this.balanceColumns()}},f=function(){this.divideIntoColumns=function(){var a=this,b=a.subviews,c=b[0],e=b[1],f=c.collection.model.prototype.idAttribute;a.left=new d(c.collection.pluck(f),c.$elements);var g=e.collection.model.prototype.idAttribute;a.right=new d(e.collection.pluck(g),e.$elements)},this.shortenColumn=function(a,b){for(var c=a===this.left?this.subviews[0]:this.subviews[1],d=a===this.left?this.right:this.left,e=d,f=b/e.$elements.length,g=c.collection,h=_.chain(a.modelIds).map(function(b,c){return[b,a.heights[c]]}).sortBy(function(a){return a[1]}).value(),i=[],j=0,k=b,l=f;h.length;){var m=h.pop(),n=m[0],o=m[1],p=o+a.interstice;if(j+p>b&&(e=a),k=Math.abs(b-(j+p)),l=k/e.$elements.length,!(l>=f)){f=l;var q=a.modelIds.indexOf(n);a.modelIds.splice(q,1),Array.prototype.splice.call(a.$elements,q,1),j+=p,i.push(n)}}g.remove(i)}},g=function(a){this.fudge=a.fudge,this.subviews=a.views.slice(0,2),1===this.subviews.length?e.call(this):f.call(this)};_.extend(g.prototype,{ascendingByHeight:function(){var a=this.left,b=this.right,c=[[a,a.height()],[b,b.height()]];return _.sortBy(c,function(a){return a[1]})},evenColumns:function(a){var b=this.ascendingByHeight(),c=b[0][0],d=b[0][1],e=b[1][0],f=b[1][1];if(d!==f){var g=f-d,h=this.fudge*g,i=_.find(e.heights,function(a){return a+e.interstice<h});return!a&&i?(this.shortenColumn(e,g),this.divideIntoColumns(),this.evenColumns("do not recurse again")):(this.increaseMargins(c,g),void 0)}},increaseMargins:function(a,b){var c=a.$elements.length;if(!(2>c)){var d=b/c;_.each(a.$elements,function(a){var b=$(a),c=parseInt(b.css("margin-bottom"),10),e=c+d;b.css("margin-bottom",e+"px")});var e=a===this.left?this.right:this.left,f=a===this.right?"left":"right";e.$elements.css("clear",f)}},render:function(){return this.divideIntoColumns(),this.evenColumns(),this}});var h=function(a){var b=a.prototype;return a.extend({templateName:"discoveryMain",events:{"click [data-action=discovery-help]":function(a){a.preventDefault(),this.model.set("help",!0)},"click [data-action=discovery-help-close]":function(a){a.preventDefault(),this.model.set("help",!1)}},toggleHelp:function(a){var b=this;b.$el.find("#discovery-note").toggle(),a.trigger("resize")},initialize:function(a){b.initialize.call(this,a),this.model.on("change:display",this.show,this),this.model.on("change:help",this.toggleHelp,this),this.$el.css({position:"absolute",visibility:"hidden",display:"block",width:"100%"})},createSections:function(){var a=this.model,b=a.get("sectionNames"),c=a.get("sectionIds");return _.map(a.collections,function(d,e){var f;return d===a.threads?f="organic":d===a.ads&&(f="promoted"),{id:c[e],className:b[e],type:f}})},render:function(){var a=this.model,b=this.createSections();this.$el.html(this.template({id:a.get("innerContainerId"),sections:b,forum:a.get("sourceForum"),session:a.get("session").toJSON(),thumbnailsEnabled:a.get("thumbnailsEnabled"),placeHelpAt:a.get("thumbnailsEnabled")?0:b.length-1}))},show:function(a){a.get("display")&&(this.$el.css({position:"static",visibility:"visible"}),a.trigger("resize"))},remove:function(a){var c;return a&&a.cloneContainer&&(c=this.el.cloneNode(!1),this.$el.attr("id",""),this.$el.after(c)),b.remove.call(this)}})}(b);return{BaseCollectionView:c,TwoColumn:g,MainView:h}}),this.Handlebars=this.Handlebars||{},this.Handlebars.discovery=this.Handlebars.discovery||{},this.Handlebars.discovery.templates=Handlebars.template(function(a,b,c,d,e){function f(a,b){var d,e="";return e+="\n    ",d=c.each.call(a,a.collection,{hash:{},inverse:R.noop,fn:R.programWithDepth(g,b,a),data:b}),(d||0===d)&&(e+=d),e+="\n"}function g(a,b,d){var e,f,g="";return g+='\n        <li class="discovery-post" id="discovery-link-',(e=c.domIdSuffix)?e=e.call(a,{hash:{},data:b}):(e=a.domIdSuffix,e=typeof e===P?e.apply(a):e),g+=Q(e)+'">\n            ',f=c["if"].call(a,(e=d.variant,null==e||e===!1?e:e.thumbnailsEnabled),{hash:{},inverse:R.programWithDepth(m,b,d),fn:R.programWithDepth(h,b,d),data:b}),(f||0===f)&&(g+=f),g+="\n        </li>\n    "}function h(a,b,e){var f,g,h,k="";return k+="\n                <a ",f=R.invokePartial(d.linkAttributes,"linkAttributes",a,c,d,b),(f||0===f)&&(k+=f),k+=' class="publisher-anchor-color">\n                    <div class="thumbnail"\n                     style="background-image: url(',(f=c.thumbnail)?f=f.call(a,{hash:{},data:b}):(f=a.thumbnail,f=typeof f===P?f.apply(a):f),k+=Q(f)+');">\n                    </div>\n                    <header class="discovery-post-header">\n                        <h3 title="',(f=c.title)?f=f.call(a,{hash:{},data:b}):(f=a.title,f=typeof f===P?f.apply(a):f),k+=Q(f)+'" class="publisher-anchor-color">\n                            <span class="title line-truncate"\n                                data-line-truncate="'+Q((f=e.variant,f=null==f||f===!1?f:f.numLinesHeadline,typeof f===P?f.apply(a):f))+'">',h={hash:{},data:b},k+=Q((f=c.html,f?f.call(a,a.title,h):S.call(a,"html",a.title,h)))+"</span>\n                            "+"\n                            ",g=c["if"].call(a,a.brand,{hash:{},inverse:R.noop,fn:R.program(4,i,b),data:b}),(g||0===g)&&(k+=g),k+="\n                        </h3>\n\n                        ",g=c.unless.call(a,(f=e.variant,null==f||f===!1?f:f.inlineMeta),{hash:{},inverse:R.noop,fn:R.program(6,j,b),data:b}),(g||0===g)&&(k+=g),k+="\n                    </header>\n                </a>\n            "}function i(a,b){var d,e="";return e+='\n                                <span class="inline-meta">\n                                    <br/>',(d=c.brand)?d=d.call(a,{hash:{},data:b}):(d=a.brand,d=typeof d===P?d.apply(a):d),e+=Q(d)+"\n                                </span>\n                            "}function j(a,b){var d,e="";return e+='\n                            <ul class="meta">\n                                ',d=c["if"].call(a,a.posts>0,{hash:{},inverse:R.noop,fn:R.program(7,k,b),data:b}),(d||0===d)&&(e+=d),e+="\n                                ",d=c["if"].call(a,a.createdAgo,{hash:{},inverse:R.noop,fn:R.program(9,l,b),data:b}),(d||0===d)&&(e+=d),e+="\n                            </ul>\n                        "}function k(a,b){var e,f="";return f+='\n                                    <li class="comments">\n                                        ',e=R.invokePartial(d.discoveryPostCount,"discoveryPostCount",a,c,d,b),(e||0===e)&&(f+=e),f+="\n                                    </li>\n                                "}function l(a,b){var d,e="";return e+='\n                                    <li class="time">',(d=c.createdAgo)?d=d.call(a,{hash:{},data:b}):(d=a.createdAgo,d=typeof d===P?d.apply(a):d),e+=Q(d)+"</li>\n                                "}function m(a,b,e){var f,g,h,i="";return i+='\n                <header class="discovery-post-header">\n                    <h3 title="',(f=c.title)?f=f.call(a,{hash:{},data:b}):(f=a.title,f=typeof f===P?f.apply(a):f),i+=Q(f)+'">\n                        <a ',f=R.invokePartial(d.linkAttributes,"linkAttributes",a,c,d,b),(f||0===f)&&(i+=f),i+=' data-role="discovery-thread-title" class="title publisher-anchor-color line-truncate" data-line-truncate="2">\n                            ',h={hash:{},data:b},i+=Q((f=c.html,f?f.call(a,a.title,h):S.call(a,"html",a.title,h)))+"\n                        </a>\n\n                        "+"\n                        "+"\n                        ",g=c["if"].call(a,(f=e.variant,null==f||f===!1?f:f.inlineMeta),{hash:{},inverse:R.noop,fn:R.program(12,n,b),data:b}),(g||0===g)&&(i+=g),i+="\n\n                    </h3>\n\n                    ",g=c.unless.call(a,(f=e.variant,null==f||f===!1?f:f.inlineMeta),{hash:{},inverse:R.noop,fn:R.program(20,s,b),data:b}),(g||0===g)&&(i+=g),i+="\n\n                </header>\n\n                ",g=c["if"].call(a,(f=e.variant,(null==f||f===!1?f:f.contentPreviews)&&a.preview),{hash:{},inverse:R.noop,fn:R.program(25,v,b),data:b}),(g||0===g)&&(i+=g),i+="\n\n            "}function n(a,b){var d,e="";return e+="\n                            ",d=c["if"].call(a,a.posts>0,{hash:{},inverse:R.program(15,p,b),fn:R.program(13,o,b),data:b}),(d||0===d)&&(e+=d),e+="\n                            ",d=c["if"].call(a,a.brand,{hash:{},inverse:R.noop,fn:R.program(18,r,b),data:b}),(d||0===d)&&(e+=d),e+="\n                        "
}function o(a,b){var e,f="";return f+='\n                                <span class="inline-meta">\n                                    ',e=R.invokePartial(d.discoveryPostCount,"discoveryPostCount",a,c,d,b),(e||0===e)&&(f+=e),f+="\n                                </span>\n                            "}function p(a,b){var d,e="";return e+="\n                                ",d=c["if"].call(a,a.createdAgo,{hash:{},inverse:R.noop,fn:R.program(16,q,b),data:b}),(d||0===d)&&(e+=d),e+="\n                            "}function q(a,b){var d,e="";return e+='\n                                    <span class="inline-meta">',(d=c.createdAgo)?d=d.call(a,{hash:{},data:b}):(d=a.createdAgo,d=typeof d===P?d.apply(a):d),e+=Q(d)+"</span>\n                                "}function r(a,b){var d,e="";return e+='\n                                <span class="inline-meta">\n                                    ',(d=c.brand)?d=d.call(a,{hash:{},data:b}):(d=a.brand,d=typeof d===P?d.apply(a):d),e+=Q(d)+"\n                                </span>\n                            "}function s(a,b){var d,e="";return e+='\n                        <ul class="meta">\n                            ',d=c["if"].call(a,a.posts>0,{hash:{},inverse:R.noop,fn:R.program(21,t,b),data:b}),(d||0===d)&&(e+=d),e+="\n                            ",d=c["if"].call(a,a.createdAgo,{hash:{},inverse:R.noop,fn:R.program(23,u,b),data:b}),(d||0===d)&&(e+=d),e+="\n                        </ul>\n                    "}function t(a,b){var e,f="";return f+='\n                                <li class="comments">\n                                    ',e=R.invokePartial(d.discoveryPostCount,"discoveryPostCount",a,c,d,b),(e||0===e)&&(f+=e),f+="\n                                </li>\n                            "}function u(a,b){var d,e="";return e+='\n                                <li class="time">',(d=c.createdAgo)?d=d.call(a,{hash:{},data:b}):(d=a.createdAgo,d=typeof d===P?d.apply(a):d),e+=Q(d)+"</li>\n                            "}function v(a,b){var e,f="";return f+="\n                    ",e=R.invokePartial(d.discoveryContentPreview,"discoveryContentPreview",a,c,d,b),(e||0===e)&&(f+=e),f+="\n                "}function w(a,b){var d,e="";return e+='\n    href="',(d=c.redirectUrl)?d=d.call(a,{hash:{},data:b}):(d=a.redirectUrl,d=typeof d===P?d.apply(a):d),e+=Q(d)+'" ',d=c["if"].call(a,a.brand,{hash:{},inverse:R.noop,fn:R.program(28,x,b),data:b}),(d||0===d)&&(e+=d),e+="\n"}function x(){return'target="_blank" rel="nofollow norewrite"'}function y(a,b){var e,f,g="";return g+="\n    <a ",e=R.invokePartial(d.linkAttributes,"linkAttributes",a,c,d,b),(e||0===e)&&(g+=e),g+=' class="top-comment" data-role="discovery-top-comment">\n        <img data-src="'+Q((e=a.preview,e=null==e||e===!1?e:e.author,e=null==e||e===!1?e:e.avatar,e=null==e||e===!1?e:e.cache,typeof e===P?e.apply(a):e))+'" alt="',f={hash:{},data:b},g+=Q((e=c.t,e?e.call(a,gettext("Avatar"),f):S.call(a,"t",gettext("Avatar"),f)))+'" data-role="discovery-avatar">\n        <p><span class="user" data-role="discovery-top-comment-author">'+Q((e=a.preview,e=null==e||e===!1?e:e.author,e=null==e||e===!1?e:e.name,typeof e===P?e.apply(a):e))+'</span> &#8212; <span data-role="discovery-top-comment-snippet" class="line-truncate" data-line-truncate="3">'+Q((e=a.preview,e=null==e||e===!1?e:e.plaintext,typeof e===P?e.apply(a):e))+"</span></p>\n    </a>\n"}function z(a,b){var d,e="";return e+="\n    ",d=c["if"].call(a,1===a.posts,{hash:{},inverse:R.program(35,B,b),fn:R.program(33,A,b),data:b}),(d||0===d)&&(e+=d),e+="\n"}function A(a,b){var d,e,f="";return f+="\n        ",e={hash:{},data:b},f+=Q((d=c.t,d?d.call(a,gettext("1 comment"),e):S.call(a,"t",gettext("1 comment"),e)))+"\n    "}function B(a,b){var d,e,f="";return f+="\n        ",e={hash:{numPosts:a.posts},data:b},f+=Q((d=c.t,d?d.call(a,gettext("%(numPosts)s comments"),e):S.call(a,"t",gettext("%(numPosts)s comments"),e)))+"\n    "}function C(a,b,d){var e,f,g,h="";return h+='\n<div id="',(e=c.id)?e=e.call(a,{hash:{},data:b}):(e=a.id,e=typeof e===P?e.apply(a):e),h+=Q(e)+'" class="discovery-main',e=c["if"].call(a,a.thumbnailsEnabled,{hash:{},inverse:R.noop,fn:R.program(38,D,b),data:b}),(e||0===e)&&(h+=e),h+='">\n    <div id="discovery-note" style="display:none;">\n        <div class="alert">\n        <a href="#" class="close" data-action="discovery-help-close" title="',g={hash:{},data:b},h+=Q((e=c.t,e?e.call(a,gettext("Close this box"),g):S.call(a,"t",gettext("Close this box"),g)))+'">×</a>\n        ',g={hash:{learnMore:{partial:"learnMore",context:d,executePartial:!0},feedback:{partial:"feedback",context:d,executePartial:!0}},data:b},h+=Q((e=c.t,e?e.call(a,gettext("Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s."),g):S.call(a,"t",gettext("Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s."),g)))+"\n        </div>\n    </div>\n\n    ",f=c.each.call(a,a.sections,{hash:{},inverse:R.noop,fn:R.programWithDepth(E,b,a),data:b}),(f||0===f)&&(h+=f),h+="\n\n</div>\n"}function D(){return" discovery-thumbnails"}function E(a,b,d){var e,f="";return f+='\n        <section id="',(e=c.id)?e=e.call(a,{hash:{},data:b}):(e=a.id,e=typeof e===P?e.apply(a):e),f+=Q(e)+'" class="',(e=c.className)?e=e.call(a,{hash:{},data:b}):(e=a.className,e=typeof e===P?e.apply(a):e),f+=Q(e)+'">\n            <header class="discovery-col-header">\n                ',e=c["if"].call(a,b.index===d.placeHelpAt,{hash:{},inverse:R.noop,fn:R.program(41,F,b),data:b}),(e||0===e)&&(f+=e),f+="\n\n                ",e=c["if"].call(a,"organic"===a.type,{hash:{},inverse:R.noop,fn:R.programWithDepth(G,b,d),data:b}),(e||0===e)&&(f+=e),f+="\n                ",e=c["if"].call(a,"promoted"===a.type,{hash:{},inverse:R.noop,fn:R.program(45,H,b),data:b}),(e||0===e)&&(f+=e),f+='\n\n            </header>\n            <ul class="discovery-posts">\n            </ul>\n        </section>\n    '}function F(a,b){var d,e,f="";return f+='\n                    \n                    <div class="discovery-options">\n                        <span class="publisher-anchor-color"><a href="#" class="discovery-help" data-action="discovery-help">',e={hash:{},data:b},f+=Q((d=c.t,d?d.call(a,gettext("What's this?"),e):S.call(a,"t",gettext("What's this?"),e)))+"</a></span>\n                    </div>\n                "}function G(a,b,d){var e,f,g="";return g+="\n                    <h2>",f={hash:{forumName:{partial:"forumName",context:d.forum,executePartial:!0}},data:b},g+=Q((e=c.t,e?e.call(a,gettext("Also on %(forumName)s"),f):S.call(a,"t",gettext("Also on %(forumName)s"),f)))+"</h2>\n                "}function H(a,b){var d,e,f="";return f+="\n                    <h2>",e={hash:{},data:b},f+=Q((d=c.t,d?d.call(a,gettext("Around The Web"),e):S.call(a,"t",gettext("Around The Web"),e)))+"</h2>\n                "}function I(a,b){var d,e,f="";return f+='\n    <a href="http://help.disqus.com/customer/portal/articles/666278-introducing-promoted-discovery-and-f-a-q-"\n        target="_blank">',e={hash:{},data:b},f+=Q((d=c.t,d?d.call(a,gettext("Learn more"),e):S.call(a,"t",gettext("Learn more"),e)))+"</a>\n"}function J(a,b){var d,e,f="";return f+='\n    <a href="https://www.surveymonkey.com/s/GHK872T" target="_blank">\n        ',e={hash:{},data:b},f+=Q((d=c.t,d?d.call(a,gettext("give us feedback"),e):S.call(a,"t",gettext("give us feedback"),e)))+"</a>"}function K(a,b){var d,e="";return e+="\n    <strong>",(d=c.name)?d=d.call(a,{hash:{},data:b}):(d=a.name,d=typeof d===P?d.apply(a):d),e+=Q(d)+"</strong>\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],c=c||a.helpers,d=d||a.partials,e=e||{};var L,M,N,O="",P="function",Q=this.escapeExpression,R=this,S=c.helperMissing;return N={hash:{},inverse:R.noop,fn:R.program(1,f,e),data:e},L=c.partial,M=L?L.call(b,"discoveryCollection",N):S.call(b,"partial","discoveryCollection",N),(M||0===M)&&(O+=M),O+="\n\n",N={hash:{},inverse:R.noop,fn:R.program(27,w,e),data:e},L=c.partial,M=L?L.call(b,"linkAttributes",N):S.call(b,"partial","linkAttributes",N),(M||0===M)&&(O+=M),O+="\n\n",N={hash:{},inverse:R.noop,fn:R.program(30,y,e),data:e},L=c.partial,M=L?L.call(b,"discoveryContentPreview",N):S.call(b,"partial","discoveryContentPreview",N),(M||0===M)&&(O+=M),O+="\n\n",N={hash:{},inverse:R.noop,fn:R.program(32,z,e),data:e},L=c.partial,M=L?L.call(b,"discoveryPostCount",N):S.call(b,"partial","discoveryPostCount",N),(M||0===M)&&(O+=M),O+="\n\n",N={hash:{},inverse:R.noop,fn:R.programWithDepth(C,e,b),data:e},L=c.partial,M=L?L.call(b,"discoveryMain",N):S.call(b,"partial","discoveryMain",N),(M||0===M)&&(O+=M),O+="\n\n",N={hash:{},inverse:R.noop,fn:R.program(47,I,e),data:e},L=c.partial,M=L?L.call(b,"learnMore",N):S.call(b,"partial","learnMore",N),(M||0===M)&&(O+=M),O+="\n\n",N={hash:{},inverse:R.noop,fn:R.program(49,J,e),data:e},L=c.partial,M=L?L.call(b,"feedback",N):S.call(b,"partial","feedback",N),(M||0===M)&&(O+=M),O+="\n\n\n",N={hash:{},inverse:R.noop,fn:R.program(51,K,e),data:e},L=c.partial,M=L?L.call(b,"forumName",N):S.call(b,"partial","forumName",N),(M||0===M)&&(O+=M),O+="\n"});